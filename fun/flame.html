<!DOCTYPE html>
<html>
<body style="margin: 0; overflow: hidden">
<script id="flame1.frag" type="x-shader/x-fragment">
  uniform float time;
  uniform vec2 rez;
  uniform vec2 mouse;
  uniform float zoom;
  uniform int iter;
  uniform sampler2D iChannel0;
  varying vec2 fragCoord;
  vec2 cmul(vec2 a, vec2 b) {
    return vec2(a.x*b.x - a.y*b.y, a.x*b.y + a.y*b.x);
  }
  vec2 csqr(vec2 a) {
    return vec2(a.x*a.x - a.y*a.y, 2.*a.x*a.y);
  }
  vec3 dmul(vec3 a, vec3 b) {
    float r = length(a);
    b.xy = cmul(normalize(a.xy), b.xy);
    b.yz = cmul(normalize(a.yz), b.yz);
    return r*b;
  }
  vec3 pow4(vec3 z) {
    z = dmul(z,z);
    return dmul(z,z);
  }
  vec3 pow3(vec3 z) {
    float r2 = dot(z,z);
    vec2 a = z.xy; a = csqr(a) / dot(a,a);
    vec2 b = z.yz; b = csqr(b) / dot(b,b);
    vec2 c = z.xz; c = csqr(c) / dot(c,c);
    z.xy = cmul(a, z.xy);
    z.yz = cmul(b, z.yz);
    z.xz = cmul(c, z.xz);
    return r2*z;
  }
  mat2 rot(float a) {
    return mat2(cos(a), sin(a), -sin(a), cos(a));
  }
  float field(in vec3 p) {
    float res = 0.;
    vec3 c = p;
    for (int i = 0; i < 50; ++i) {
      if (i > iter) {
        break;
      }
      p = abs(p) / dot(p,p) -1.;
      p = sin(p) + cos(p);
      p = dmul(p, p) + 0.1 + dot(p,c);
      res += exp(-8. * abs(dot(p, c) - .05));
    }
    return max(0., res/3.);
  }
  vec3 raycast(in vec3 ro, vec3 rd) {
    float t = 6.0;
    float dt = .05;
    vec3 col = vec3(0.);
    for (int i = 0; i < 4; i++) {
      float c = field(ro + t * rd);
      t += dt / (.35 + c * c);
      c = max(5.0 * c - .9, 0.0);
      col = .99 * col + .08 * vec3(c * c, c * c, c);
    }
    return col;
  }
  void main() {
    float time = time;
    vec2 q = fragCoord.xy / rez.xy;
    vec2 m = mouse.xy / rez.xy * 6.28;
    vec3 ro = zoom * vec3(1.);
    ro.xz *= rot(m.x);
    ro.yz *= rot(m.y);
    vec3 ta = vec3(0.0, 0.0, 0.0);
    vec3 ww = normalize(ta - ro);
    vec3 uu = normalize(cross(ww, vec3(0.0, 1.0, 0.0)));
    vec3 vv = normalize(cross(uu, ww));
    vec3 rd = normalize(q.x*uu + q.y*vv + ww);
    vec3 col = raycast(ro, rd);
    col = .5 * (log(1. + col));
    col = clamp(col, 0., 1.);
    gl_FragColor = vec4(sqrt(col), 1.0);
  }
</script>
<script id="flame2.frag" type="x-shader/x-fragment">
  uniform float time;
  uniform vec2 rez;
  uniform vec2 mouse;
  uniform float zoom;
  uniform int iter;
  varying vec2 fragCoord;

  const float Tau = 6.28571428571428571428;
  float randCount = mouse.x * 0.001 * mouse.y * 0.001;

  // Random.
  float R() {
    randCount++;
    return 2. * fract(randCount * Tau) - 1.;
  }

  void main() {
    const float fR = 8.*Tau;
    float f1 = fR, f2 = fR, f3 = fR, f4 = fR;
    const float iR = 1.*Tau;
    float i1 = iR, i2 = iR, i3 = iR;
    const float cR = 1.*Tau;
    float c1 = cR, c2 = cR, c3 = cR, c4 = cR;
    float x = fragCoord.x / rez.x;
    float y = fragCoord.y / rez.y;
    // phase delta
    float pD = time;
    float r, g, b;
    for (int n = 0; n < 50; n++) {
      if (n > iter) break;
      i1 = i1 * R();
      i2 = i2 * R();
      i3 = i3 * R();
      f1 = f1 * R();
      f2 = f2 * R();
      c1 = c1 * R(), c2 = c2 * R(), c3 = c3 * R(), c4 = c4 * R();
      x = x + c1 * cos(f1 * x + pD) - y + c2 * sin(f2 * y + pD);
      y = y + c3 * tan(f3 * y + pD) - x + c4 * atan(f4 * x + pD);
      r += r + i1 * x + i2 * y;
      g += g + i2 * x + i3 * y;
      b += b + i3 * x + i1 * y;
    }
    gl_FragColor.r = r;
    gl_FragColor.g = g;
    gl_FragColor.b = b;
  }
</script>
<script id="main.vert" type="x-shader/x-vertex">
  attribute vec3 in_Position;
  varying vec2 fragCoord;
  void main() {
    vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
    gl_Position = projectionMatrix * mvPosition;
    fragCoord = position.xy;
  }
</script>
<script type="module" src="flame.js"></script>
